unit UnitMain;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes,
  Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Menus, Vcl.ExtCtrls,
  Vcl.StdCtrls, Vcl.ComCtrls, Vcl.FileCtrl, ShellAPI, Vcl.ImgList, System.ImageList,System.StrUtils,
  System.Math, IniFiles, Registry, Vcl.Themes, Vcl.Styles, XPopupMenu, Vcl.PlatformDefaultStyleActnCtrls, Vcl.ActnPopup, Vcl.VirtualImageList, SVGIconVirtualImageList, Vcl.BaseImageCollection,
  SVGIconImageCollection, SVGIconImageListBase, SVGIconImageList, SVGIconImage;

type

  TDados = class(TComponent)
    private
    fdados:String;
    //property dados: String read fdados write fdados;
  end;

  TFormMain = class(TForm)
    TrayIcon: TTrayIcon;
    OpenDialog: TOpenDialog;
    ImageList: TImageList;
    ppMenuEdit: TXPopupMenu;
    Adicionar_item1: TMenuItem;
    Editar_Item1: TMenuItem;
    PopupMenu: TXPopupMenu;
    Excluir_Item1: TMenuItem;
    Criar_separador1: TMenuItem;
    Fechar1: TMenuItem;
    N1: TMenuItem;
    Adicionar_submenu1: TMenuItem;
    N2: TMenuItem;
    emas1: TMenuItem;
    N3: TMenuItem;
    Dark1: TMenuItem;
    Dark2: TMenuItem;
    Edit1: TMenuItem;
    Atualizar1: TMenuItem;
    //procedure WMEndSession(var Msg : TWMEndSession); message WM_QUIT;
    procedure FormCreate(Sender: TObject);
    procedure ExecuteClick(Sender: TObject);
    procedure Edit1Click(Sender: TObject);
    procedure PopupMenuMenuRightClick(Sender: TObject; Item: TMenuItem);
    procedure Adicionar_item1Click(Sender: TObject);
    procedure Fechar1Click(Sender: TObject);
    procedure Editar_Item1Click(Sender: TObject);
    procedure Excluir_Item1Click(Sender: TObject);
    procedure Criar_separador1Click(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure Dark1Click(Sender: TObject);
    procedure Dark2Click(Sender: TObject);
    procedure Atualizar1Click(Sender: TObject);
  private
    //procedure WndProc(var Wsg: TMessage); override;
    function  ExtractIconFromFile(const FileName: string): Integer;
    procedure RegistrarNoIniciarWindows();
    procedure SetThemes();
    procedure CriarMenu();
    procedure add_ini(ini:TMemIniFile;leitura:Boolean=false);
    function  Pega(var pText: String; pC: Char='|'): String;
    procedure Atualizar_menu();
  end;

  procedure Terminar();

var
  FormMain: TFormMain;
  usaicon: String;
  iDark: String;
  iniciar: String;
  vItemMenu: TMenuItem;
  vIndex: integer;


implementation

{$R *.dfm}

uses UnitAddShortcut;

procedure Terminar();
var
  hprocessID: INTEGER;
  processHandle: THandle;
begin
  if isWindow(application.Handle) then begin
    GetWindowThreadProcessID(application.Handle, @hprocessID);
    if hprocessID <> 0 then begin
      processHandle := OpenProcess(PROCESS_TERMINATE or PROCESS_QUERY_INFORMATION, False, hprocessID);
      if processHandle <> 0 then begin
        TerminateProcess(processHandle, 0);
        CloseHandle(ProcessHandle);
      end;
    end;
  end;
end;

//procedure TFormMain.WMEndSession(var Msg : TWMEndSession);
//begin
//end;

//procedure TFormMain.WndProc(var Wsg: TMessage);
//begin
//  if  (Wsg.Msg = WM_ENDSESSION) or (Wsg.Msg = WM_QUIT) or (Wsg.Msg = WM_QUERYENDSESSION) or (Wsg.Msg = WM_CLOSE) then begin
//  end else
//   inherited WndProc(Wsg);
//end;

procedure TFormMain.Fechar1Click(Sender: TObject);
begin
  Close;
end;

procedure TFormMain.add_ini(ini:TMemIniFile;leitura:Boolean=false);
begin
  if leitura then begin
    usaicon := ini.ReadString('CONFIG','COM_ICONE','S');
    iniciar := ini.ReadString('CONFIG','COM_INICIAR','S');
    iDark   := ini.ReadString('CONFIG','COM_DARK','N');
  end else begin
    ini.WriteString('CONFIG','COM_ICONE',usaIcon);
    ini.WriteString('CONFIG','COM_INICIAR',iniciar);
    ini.WriteString('CONFIG','COM_DARK',iDark);
  end;
end;

procedure TFormMain.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Action := caFree;
  Terminar();
end;

procedure TFormMain.FormCreate(Sender: TObject);
begin
  usaicon := 'S';
  iniciar := 'S'; 
  iDark   := 'N';

  CriarMenu();

  if usaicon = 'S' then
    PopupMenu.Images := ImageList;

  TrayIcon.Icon := Application.Icon;

  RegistrarNoIniciarWindows();
  SetThemes();
end;

function TFormMain.Pega(Var pText:String;pC:Char='|'):String;
begin
  Result:='';
  var Posicao := Pos(pC, pText);
  if Posicao > 0 then begin
    Result := Copy(pText, 1, Posicao - 1);
    pText := Copy(pText, Posicao + 1, Length(pText) - Posicao);
  end else begin
    Result := pText;
    pText  := '';
  end;
end;

procedure TFormMain.CriarMenu();
var ArquivoINI : TMemIniFile;
    cp:TDados;
    param:String;

  procedure findSection(section:String;itemMenu:TMenuItem);
  begin
    if section.IsEmpty then
      exit;

    var parte2 := section;
    var parte1 := pega(parte2);

    var newItem := ItemMenu.Find( parte1 );
    if newItem = nil then begin
      newItem := TMenuItem.Create(itemMenu);
      newItem.ImageIndex := -1;

      param := '';
      if parte1.Contains('-linha-') then begin
        newItem.Caption := '-';
      end else begin
        param := ArquivoINI.ReadString(section,'Parametros','');
        cp := TDados.Create(nil);
        cp.fdados := param;

        newItem.InsertComponent(cp);
        newItem.Caption := parte1;
      end;

      if usaIcon = 'S' then begin
        var IconIndex := ExtractIconFromFile( newItem.Caption );
        if IconIndex >-1 then begin
          newItem.ImageIndex := IconIndex;
        end else if param = 'submenu' then begin
          newItem.ImageIndex := 0;
        end;
      end;

      newItem.OnClick    := ExecuteClick;
      ItemMenu.Add(newItem);
    end;

    if parte2.IsEmpty then
      exit;

    if newItem.Name = '' then
      newItem.Name := newItem.Caption;

    newItem.ImageIndex := 0;

    findSection(parte2,newItem);
  end;

begin
  ArquivoINI := TMemIniFile.Create( ExtractFilePath(Application.ExeName)+'Atalhos.ini' );
  add_ini(ArquivoINI,true);

  if PopupMenu.Items.Count = 0 then begin
    PopupMenu.Items.Clear;
  end;


  try
    var S:=TStringList.Create;
    try
      ArquivoINI.ReadSections(S);

      for var I := 0 to S.Count-1 do begin
        if s[i] <> 'CONFIG' then
          findSection(s[i],PopupMenu.Items);
      end;


      if PopupMenu.Items.Count = 0 then begin
        var mm := TMenuItem.Create(PopupMenu);
        mm.Caption := 'Sair';
        mm.name := 'sair';
        mm.OnClick := Fechar1Click;
        PopupMenu.Items.add(mm);
      end;


    finally
      FreeAndNil(s);
    end;
  finally
    FreeAndNil(ArquivoINI);
  end;

end;

procedure TFormMain.SetThemes();
begin
  if iDark = 'S' then
    TStyleManager.TrySetStyle('Windows11 Modern Dark')
  else
    TStyleManager.TrySetStyle('Windows'); //11 Modern Light');
end;

procedure TFormMain.Dark1Click(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Windows11 Modern Dark');
  iDark := 'S';
  PopupMenu.CloseMenu;
end;

procedure TFormMain.Dark2Click(Sender: TObject);
begin
  TStyleManager.TrySetStyle('Windows'); //11 Modern Light');
  iDark := 'N';
  PopupMenu.CloseMenu;
end;

procedure TFormMain.RegistrarNoIniciarWindows();
var Reg: TRegistry;
    S:String;
begin
  Reg := TRegistry.Create;
  try
    S:=Application.ExeName;
    Reg.rootkey:=HKEY_CURRENT_USER;
    Reg.Openkey('SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN',false);
    Reg.DeleteValue( ExtractFileName(S).ToLower.Replace('.exe',''));
    if iniciar='S' then
      Reg.WriteString(ExtractFileName(S).ToLower.Replace('.exe',''),S);
    Reg.closekey;
  finally
   FreeAndNil(Reg);
  end;
end;

procedure TFormMain.Adicionar_item1Click(Sender: TObject);
var
  SaveIndex,I: Integer;
  nome,param:String;
  esubmenu:boolean;
begin
  if (vItemMenu = nil) or vItemMenu.IsLine then
    exit;

  nome     := '';
  param    := '';
  esubmenu := TMenuItem(Sender).name =  'Adicionar_submenu1';

  if esubmenu then
    param := 'submenu';

  if CadastroMenu(nome,param,'i') then begin

    var itemMenu := TMenuItem.Create(nil);
    itemMenu.Caption := nome;
    itemMenu.OnClick := ExecuteClick;
    itemMenu.ImageIndex := -1;

    if usaIcon = 'S' then begin
      if esubmenu then begin
        itemMenu.ImageIndex := 0;
      end else begin
        I := ExtractIconFromFile(nome);
        if I >-1 then
          itemMenu.ImageIndex := I;
      end;
    end;

    var cp := TDados.Create(nil);
    cp.fdados := param;

    itemMenu.InsertComponent(cp);

    if TDados(vItemMenu.Components[0]).fdados = 'submenu' then
      vItemMenu.Add(itemMenu)
    else if (vItemMenu.Parent.name <> '')  then
      vItemMenu.Parent.Insert(vItemMenu.MenuIndex,itemMenu)
    else
      PopupMenu.Items.Insert(vItemMenu.MenuIndex,itemMenu);

    Atualizar_menu();
  end;
end;

procedure TFormMain.Editar_Item1Click(Sender: TObject);
var
  nome,param:String;
begin
  if (vItemMenu.name = 'sair') or (vItemMenu = nil) then
    exit;

  nome := vItemMenu.Caption;
  if vItemMenu.ComponentCount > 0 then
    param := TDados(vItemMenu.Components[0]).fdados;

  if (param <> 'submenu') and (vItemMenu.Count > 0) then
    param := 'submenu';

  if not CadastroMenu(nome,param,'e') then
    exit;

  vItemMenu.Caption :=  nome;

  if vItemMenu.ComponentCount = 0 then begin
    var cp := TDados.Create(nil);
    cp.fdados := param;
    vItemMenu.InsertComponent(cp);
  end else
    TDados(vItemMenu.Components[0]).fdados := param;

  Atualizar_menu();
end;

procedure TFormMain.Excluir_Item1Click(Sender: TObject);
begin
  if (vItemMenu.name = 'sair') or (vItemMenu.Count > 0) then
    exit;

  FreeAndNil(vItemMenu);

  if iDark = 'S' then
    PopupMenu.CloseMenu;

  Atualizar_menu();
end;

procedure TFormMain.Criar_separador1Click(Sender: TObject);
var sub:String;
begin
  if (vItemMenu.name = 'sair') or (vItemMenu = nil) then
    exit;

  var itemMenu := TMenuItem.Create(vItemMenu);

  if TDados(vItemMenu.Components[0]).fdados = 'submenu' then
    vItemMenu.InsertNewLineBefore(itemMenu)
  else if (vItemMenu.Parent.name <> '')  then
    vItemMenu.Parent.InsertNewLineBefore(vItemMenu)
  else
    PopupMenu.Items.InsertNewLineBefore(vItemMenu);

  if iDark = 'S' then
    PopupMenu.CloseMenu;

  Atualizar_menu();
end;

procedure TFormMain.PopupMenuMenuRightClick(Sender: TObject; Item: TMenuItem);
begin
  if Item.Enabled then begin
    PopupMenu.tag := Item.MenuIndex;
    vItemMenu := Item;
    PopupMenu.OverPopupMenu(ppMenuEdit);
  end;
end;

procedure TFormMain.Edit1Click(Sender: TObject);
begin
  ShellExecute(0, 'open', PChar( ExtractFilePath(Application.ExeName)+'Atalhos.ini' ), nil, nil, SW_SHOWNORMAL);
end;

procedure TFormMain.ExecuteClick(Sender: TObject);
var nome,param:String;
begin
  nome := StringReplace(TMenuItem(Sender).Caption, '&', '', [rfReplaceAll]);
  if TMenuItem(Sender).ComponentCount > 0 then
    param := TDados(TMenuItem(Sender).Components[0]).fdados;

  ShellExecute(0, 'open', PChar( nome ), PChar(param), nil, SW_SHOWNORMAL);
end;

procedure TFormMain.Atualizar1Click(Sender: TObject);
begin
  CriarMenu();
end;

procedure TFormMain.Atualizar_menu();
var
 TempINI : TMemIniFile;
 param   : String;

  procedure findMenu(subMenu:String;itemMenu:TMenuItem);
  begin
    for var I := 0 to itemMenu.Count - 1 do begin
      if (itemMenu.Items[I] <> nil) and (itemMenu.Items[I].Name <> 'sair') then begin

        if itemMenu.Items[i].Count > 0 then begin

          findMenu( submenu + itemMenu.Items[I].Caption+'|'  , itemMenu.Items[i]);

        end else begin

          if itemMenu.Items[I].IsLine then begin
            TempINI.WriteString(subMenu + '-linha-'+I.ToString, 'Parametros',I.ToString);
          end else begin
            param := '';
            if itemMenu.Items[I].ComponentCount > 0 then begin
              param := TDados(itemMenu.Items[I].Components[0]).fdados;
              /////FreeAndNil( itemMenu.Items[I].Components[0] );
            end;
            TempINI.WriteString( subMenu + itemMenu.Items[I].Caption,'Parametros',param );
          end;

        end;
      end;
    end;
  end;

begin
  TempINI := TMemIniFile.Create( ExtractFilePath(Application.ExeName)+'Atalhos.ini' );
  try
    TempINI.Clear;
    add_ini(TempINI,false);
    findMenu('',PopupMenu.Items);
    TempINI.UpdateFile;
  finally
    FreeAndNil(TempIni);
  end;

end;

function TFormMain.ExtractIconFromFile(const FileName: string): Integer;
var
  IconeHandle: HICON;
  Icon: TIcon;
begin
  Result := -1; // Define como erro caso falhe
  if ExtractIconEx(PChar(FileName), 0, HICON(nil^), IconeHandle, 1) > 0 then
  begin
    if IconeHandle <> 0 then begin
      Icon := TIcon.Create;
      try
        Icon.Handle := IconeHandle;
        Result := ImageList.AddIcon(Icon);
      finally
        Icon.Free;
        DestroyIcon(IconeHandle);
      end;
    end;
  end;
end;

end.




